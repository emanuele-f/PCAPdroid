**[Оглавление](index)	>	Расшифровка TLS**

## 3.1 Расшифровка HTTPS/TLS

PCAPdroid предоставляет возможность отправлять весь TCP траффик через SOCKS5 прокси. Подключая [mitmproxy](https://github.com/emanuele-f/mitmproxy) в режиме SOCKS5 позволяет расшифровывать траффик на удаленной машине. Расшифровка TLS может быть использована например для изучения чистых (не зашифрованных) данных в HTTPS запросах.

`mitmproxy` может быть установлен по [официальной инструкции по установке](https://docs.mitmproxy.org/stable/overview-installation). Для запуска в режиме SOCKS5 прокси используется следующая команда:

```
mitmproxy --mode socks5 --listen-port 8050
```

Для полного списка инструментов и возможных опций обратитесь к [документации mitmproxy](https://docs.mitmproxy.org/stable). Следует отметить что до версии 1.3.5, для PCAPdroid необходим [модифицированный mitmproxy](https://github.com/emanuele-f/mitmproxy) запускаемый с опцией `--mode tunnel`.

Для включения расшифровки TLS в PCAPdroid:

1. Установите сертификат от mitmproxy (расположен по пути `~/.mitmproxy/mitmproxy-ca-cert.cer` на устройстве где установлен сам mitmproxy) на вашем Android-устройстве. Обычно для этого необходимо сменить расширение файла на `.crt`.
2. Откройте настройки PCAPdroid
3. Включите пункт "Enable SOCKS5 Proxy"
4. Настройте IP адрес и порт устройства на котором будет запущен mitmproxy (порт из примера выше - 8050).

Примечание: чтобы все это работало, Android-устройство и устройство на базе Linux должны быть подключены к одной сети.

Теперь PCAPdroid будет перенаправлять весь TCP траффик через сервер mitmproxy, который выступит в роли прокси и будет расшифровывать TLS траффик.
PCAP-файл сгенерированный PCAPdroid все еще будет содержать зашифрованный траффик с оригинальными IP и портом назначения пакетов.
Тем не менее, включение расшифровки TLS траффика несет с собой высокую вероятность нарушения сетевого соединения приложений, в связи с чем рекомендуется использовать фильтр приложений, чтобы захватывать траффик только конкретно указанного приложения.

## 3.2 Расшифровка с Android 7

С момента выхода Android 7 (Nougat), Android-приложения не доверяют пользовательским сертификатам установленным в системе. Это означает что они не будут принимать сертификат от mitmproxy и их соединение с сетью будет потеряно. На устройствах с Root-доступом это можно легко решить установкой сертификата в качестве системного, а не пользовательского (см. https://docs.mitmproxy.org/stable/howto-install-system-trusted-ca-android). На устройствах без Root-доступа наиболее надежный способ решить проблему - изменить конфигурацию приложения чтобы оно доверяло пользовательским сертификатам как указано в  [инструкциях для разработчиков Android приложений](https://developer.android.com/training/articles/security-config.html). Если у Вас нет доступа к исходному коду целевого приложения, можно попробовать модифицировать приложение например через [apktool](https://ibotpeaches.github.io/Apktool).

Так же, есть более простой но менее надежный способ, который не требует вмешательства в конфигурацию приложения. Используя [VirtualXposed](https://github.com/android-hacker/VirtualXposed) в совокупности PCAPdroid позволяет обмануть приложение и заставить его работать по старым политикам безопасности (действующие до выхода Android 7) при которых целевое приложение будет доверять сертификату от mitmproxy. VirtualXposed является приложением для виртуализации с открытым исходным кодом и доступно на [F-Droid](https://f-droid.org/en/packages/io.va.exposed/). Чтобы начать пользоваться VirtualXposed в совокупности с PCAPdroid:

1. Настройте расшифровку TLS траффика в PCAPdroid как было описано выше
2. Настройте фильтр приложений PCAPdroid чтобы захватывать траффик только от VirtualXposed
3. Откройте VirtualXposed, выберите "Добавить приложение" и выберите целевое приложение (в появившемся диалоге выберите "virtualxposed").
4. Запустите целевое приложение из VirtualXposed.

В чем фокус? VirtualXposed использует [целевую версию SDK](https://github.com/android-hacker/VirtualXposed/blob/vxp/VirtualApp/app/build.gradle) установленную в значение 23. Это означает, что любое приложение с целевой версией SDK меньше 24 так же как и раньше доверяет пользовательским сертификатам, и это работает даже в Android 7! Любое приложение для виртуализации с подходящей целевой версией SDK так же подходит и может провернуть этот трюк. Однако стоит помнить, что приложение виртуализации предоставляет альтернативную среду для приложений, в связи с чем приложения могут работать некорректно и даже вылетать. Модифицирование конфигурации APK остается более предпочтительным способом.

## 3.3 Сообщения об ошибках

Следующие советы могут помочь в сообщениях об ошибках с рашифровкой TLS:

- Если mitmproxy показывает предупреждение "Client Handshake Failed", это означает что все работает корректно, но приложение не доверяет сертификату сгенерированному mitmproxy. Удостоверьтесь, что сертификат mitmproxy корректно установлен и что целевое приложение принимает пользовательские сертификаты как описано выше.
- Некоторые приложения могут использовать [привязку к конкретному сертификату](https://developer.android.com/training/articles/security-ssl#Pinning). В таких случаях может помочь специальный [инструмент для модификации APK файлов](https://github.com/shroudedcode/apk-mitm).
- Если mitmproxy не отображает никакого вывода, это означает что траффик не достигает mitmproxy. В таком случае проверьте настройки подключения.
