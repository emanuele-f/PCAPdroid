**[Оглавление](index) > Дешифрование TLS**


## 3.1 Введение

Начиная с версии 1.5.0, PCAPdroid умеет дешифровывать TLS и отображать дешифрованные данные прямо в приложении. Более того, он может сгенерировать `SSLKEYLOGFILE`, содержащий секреты дешифрования, которые могут быть в последствии использованы для дешифрования полученного PCAP сторонними средствами.

Большинство приложений сегодня работают через TLS, чтобы защитить свои данные от наблюдения и изучения. Такие соединения в PCAPdroid помечаются как TLS, либо HTTPS протокол.
Дешифрование может быть полезным в следующих случаях:

- Проверить, отправляет ли приложение конфиденциальную информацию или пароли в чистом виде
- Реверс-инжиниринг протокола приложения, например с целью узнать адреса REST API
- Отладка проблем связанных с протоколом без выключения TLS шифрования

**Примечание**: перед дешифрованием вам необходимо проверить условия использования приложения, чтобы узнать разрешено ли это

**Примечание**: запуск дешифрования TLS снизит безопасность вашего приложения. Вы должны делать это только если знаете что делаете, а также в течение ограниченного времени

Текущие ограничения:

- Дешифрование TLS недоступна при захвате в root-режиме
- Дешифрование QUIC траффика [пока еще не поддерживается](https://github.com/mitmproxy/mitmproxy/issues/4170). В PCAPdroid вы можете включить блокировку QUIC протокола, что в случае некоторых приложений заставляет их [вернуться к использованию TLS](https://www.ietf.org/archive/id/draft-ietf-quic-applicability-09.html#section-2), таким образом делая эти приложения дешифруемыми
- Дешифрование STARTTLS [пока еще не поддерживается](https://github.com/mitmproxy/mitmproxy/issues/4215)
- Есть также некоторые специфичные для разных протоколов ограничения, обратитесь к [документации mitmproxy](https://docs.mitmproxy.org/stable/concepts-protocols/#protocols) за деталями

Дешифрование TLS на Android не является легкой задачей, определенные технические знания и знакомство с данной темой необходимо. Есть множество подводных камней, которые будут обсуждены ниже. Также, устройство с root-правами поможет достичь успеха в большинстве случаев.


## 3.2 Начальная настройка

Дешифрование TLS может быть включена из настроек PCAPdroid.

         В настройках PCAPdroid (значок ⚙️ в верхнем правом углу), включите переключатель **Дешифрование TLS** в разделе **Просмотр траффика**.

При первом включении, помощник настройки поможет вам правильно настроить дешифрование. Этот процесс включает в себя следующие шаги:

1. Загрузка и установка [дополнения PCAPdroid-mitm](https://github.com/emanuele-f/PCAPdroid-mitm). Фактически, процесс дешифрования производится [mitmproxy](https://github.com/mitmproxy/mitmproxy), который встроен в дополнение
2. Разрешение на управление mitm-дополнением. Это мера безопасности для предотвращения контроля дополнения другими приложениями.
3. Установка [корневого сертификата](https://docs.mitmproxy.org/stable/concepts-certificates). Корневой сертификат, это то, что позволяет PCAPdroid дешифровать траффик приложения, и чтобы сделать это, его (прим. корневой сертификат) необходимо сначала добавить в хранилище сертификатов. Для обеспечения безопасности, прямо на устройстве генерируется уникальный корневой сертификат  (прим. сертификат с другого устройства не подойдет).

Перед продолжением, проверьте имеет ли ваше устройство приложение для контроля автозапуска и фоновой активности приложений, как например [Autostart на устройствах vivo](https://www.vivo.com/en/support/questionByTitle?title=How%20to%20turn%20on/off%20Autostart%20for%20my%20apps) или раздел [Батарея на устройствах Huawei](https://consumer.huawei.com/ru/support/content/ru-ru00428704/). Если в вашей системе есть подобное приложение, вам необходимо разрешить для mitm-дополнения доступные опции запуска (например автозапуск, запуск другими приложениями) и работу в фоне. Иначе PCAPdroid не сможет запустить процесс дешифрования.


## 3.3 Дешифрование

Перед запуском дешифрования, вам необходимо выбрать целевое приложение. Дешифрование является инвазивной операцией, которая может нарушить возможность соединения некоторых приложений с интернетом из-за проблем недоверия к сертификату, поэтому хорошей практикой является ограничиться одним конкретным приложением. 

Для того, чтобы убедиться, что дешифрование работает, выберите целевым приложение которое наверняка можно дешифровать. Хорошим кандидатом на эту роль является Google Chrome. Включите дешифрование, выберите Chrome как целевое приложение и начните захват траффика в PCAPdroid. В Chrome откройте любой HTTPS сайт в новой вкладке, после чего вы должны увидеть дешифрованные данные соединений в PCAPdroid. Они обозначены значком зеленого открытого замка.

Значко замка и цвет являются индикаторами статуса дешифрования, который так же указывается и в деталях соединения:

- *зеленый*: дешифровано успешно
- *красный*: дешифрование не удалось. Откройте детали соединения и вы увидете сообщение об ошибке, описывающее почему дешифрование не увенчалось успехом.
- *оранжевый*: дешифрование не поддерживается для данного протокола или приложения (например, для протокола QUIC и некоторый специфичных приложений, см. ниже)
- *серый открытый замок*: соединение не зашифровано (например, чистый DNS)
- *серый закрытый замок*: дешифрование еще недоступно (например, ожидаются данные по данному соединению)

Вы можете отобразить дешифрованные соединения, а также те для которых дешифрование не удалось, с помощью фильтров.
Если вы откроете дешифрованное соединение, вкладки "Содержимое" и "HTTP" отобразят дешифрованное содержимое.

<p align="center">
<img src="https://raw.githubusercontent.com/emanuele-f/PCAPdroid/gh-pages/images/decryption_1.jpg" width="250" />
<img src="https://raw.githubusercontent.com/emanuele-f/PCAPdroid/gh-pages/images/decryption_2.jpg" width="250" />
</p>

Если запись дампа в PCAP включена, то по завершению захвата вы увидите запрос на сохранение `SSLKEYLOGFILE`, который вы можете загрузить в Wireshark [для дешифрования](https://wiki.wireshark.org/TLS#tls-decryption) PCAP файла.


## 3.4 Подводные камни и возможные решения

Google Chrome является относительно простым для дешифрования приложением. Если вы попробуете дешифровать другие приложения, вы вскоре столкнетесь с некоторыми проблемами, которые в большинстве случаев можно решить с помощью устройств с root-правами и правильными инструментами.

### 3.4.1 Клиент не доверяет mitm сертификату

Данная ошибка дешифрования может случаться по разным причинам:

- Android версии 7 или новее, а также приложение со значением целевого SDK более 23
- Приложение использует стороннее хранилище доверенных сертификатов
- У приложения включена [привязка к сертификату](https://developer.android.com/training/articles/security-ssl#Pinning)

<p align="center">
<img src="https://raw.githubusercontent.com/emanuele-f/PCAPdroid/gh-pages/images/tls_cert_not_trusted.jpg" width="250" />
</p>

Если у вас Android 7 или новее, и приложение, которое вы пытаетесь дешифровать имеет значение целевого SDK больше 23, то это наиболее частая причина, по которой mitm-сертификат будет отвергнут приложением (т.к. приложения больше не доверяют пользовательским сертификатам). Чтобы решить данную проблему, вам потребуется:

- Если у вас есть исходный код приложения и вы можете сами его собрать, обратитесь к [документации Android](https://developer.android.com/training/articles/security-config.html) чтобы настроить доверие к корневому сертификату PCAPdroid. В XML конфигурации сетевой безопасности, вы можете указать домены верхнего уровня, например, `<domain includeSubdomains="true">com</domain>` чтобы использовать корневой сертификат для mitm атаки на любой `.com` домен. Чтобы указать сертфикат, переименуйте в `pcapdroid.crt` корневой сертификат PCAPdroid, экспортированный в процессе настройки дешифрования TLS. Затем поместите его в папку `raw` ресурсов. Пожалуйста помните о том, что некоторые библиотеки также могут использовать стороннее хранилище доверенных сертификатов - обратитесь к их документации по данному вопросу

- На устройстве с root-правами и Magisk, вы можете установить [плагин MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts), который добавляет пользовательские сертификаты в системное хранилище посредством оверлеев файловой системы. Это рекомендуемый вариант в случае, если у вас есть Magisk
- На любом устройстве с root-правами вы можете установить сертификат [в системное хранилище](https://docs.mitmproxy.org/stable/howto-install-system-trusted-ca-android/#3-insert-certificate-into-system-certificate-store), предварительно примонтировав системный раздел в режиме `rw`
- Вы можете использовать [apktool](https://ibotpeaches.github.io/Apktool), чтобы декомпилировать приложение, снизить значение целевого SDK до 23 и пересобрать приложение
- Вы можете использовать [VirtualXposed](https://github.com/android-hacker/VirtualXposed) чтобы виртуализировать целевое приложение (тогда оно запустится как будто его целевой SDK имеет значение 23). Android 11 и новее [пока еще не поддерживаются](https://github.com/android-hacker/VirtualXposed/issues/1073). Чтобы использовать данный метод, откройте VirtualXposed, выберите "Добавить приложение" и установите то приложение, траффик которого вы хотите дешифровать (при запросе метода установки используйте метод "virtualxposed"). Затем, в PCAPdroid, выберите VirtualXposed в качестве целевого приложения для дешифрования. К сожалениею виртуализация довольно ненадежный метод, поэтому стоит ожидать вылетов целевого приложения (прим. установленного внутри VirtualXposed)

Помимо прочего, некоторые приложения (чаще всего браузеры) используют сторонние хранилища доверенных сертификатов, независящие от системного хранилища. Вам необходимо выяснить - есть ли у них опция для отключения такого поведения, например в Firefox [вы можете сделать это](https://support.mozilla.org/en-US/questions/1304237) через `about:config`. Если такой опции не предусмотрено, то вам необходимо будет патчить приложение.

Если клиент все еще отказывается соединяться, тогда приложение, возможно, использует привязку к сертификату, что означает, что приложение активно производит проверку сертификатов по своему белому списку.
Чтобы обойти это, потребуется:

- На устройстве с root-правами и Magisk, установите [модуль LSposed](https://github.com/LSPosed/LSPosed). Затем установите модуль [sslunpinning](https://github.com/Xposed-Modules-Repo/io.github.tehcneko.sslunpinning/releases)
- Вы можете использвать [apk-mitm](https://github.com/shroudedcode/apk-mitm) для пересборки пропатченного apk с отключенной привязкой к сертификатам
- Если не работает ничего из вышеперечисленного, тогда приложение скорее всего использует какую-то другую логику привязки к сертификатам. В этом случае вам необходимо вручную распаковывать приложение, заниматься его реверс-инжинирингом и патчить


### 3.4.2 Прозрачность сертификата

При дешифровании траффика браузера, браузер может отказаться от соединения с браузерами, сообщая об ошибке связанной с прозрачностью сертификатов. С контролем [прозрачности сертификатов](https://en.wikipedia.org/wiki/Certificate_Transparency), сторонние корневые сертификаты добавленные в систему обычно отвергаются. Чтобы исправить это, необходимо:

- В некоторых браузерах, вы можете отключить контроль прозрачности сертификатов, например, в Bromite посредством опций в `chrome://flags`
- Удалите корневой сертификат PCAPdroid из системного хранилища или просто временно выключите его из настроек безопасности в Android
- Если корневой сертификат PCAPdroid установлен в системное хранилище посредством плагина `MagiskTrustUserCerts`, тогда вы можете использовать *magisk hide* на браузер, чтобы он распознавал сертификат PCAPdroid не как системный

### 3.4.3 Траффик все еще зашифрован

После дешифрования TLS траффика, содержимое все еще может быть зашифровано с использованием других протоколов. Это происходит, в частности, с Telegram и Whatsapp, которые используют свой собственный протокол шифрования. Подобные протоколы требуют разработки собственных инструментов для дешифрования, что выходит за рамки PCAPdroid.

Более того, помните что результат дешифрования может оказаться *бинарный* протокол, который не имеет удобо-читаемого для человека представления. Важно понимать, что *бинарный* протокол не обязательно означает что он зашифрован. Например, DNS является бинарным протоколом, но он не зашифрован.


## 3.5 Дешифрование через внешний mitmproxy

Для большей гибкости, к примеру, чтобы модифицировать траффик или использовать вышестоящий прокси, вы можете производить дешифрование TLS на любом другом SOCKS5 прокси, возможно запущенном на другом устройстве. Ниже пример того, как настроить для этого `mitmproxy`.

На ПК вы можете установить `mitmproxy` следуя [официальной инструкции по установке](https://docs.mitmproxy.org/stable/overview-installation). Оба устройства (ПК и Android с запущенным PCAPdroid) должны быть подключены к одной сети для этого. В качестве альтернативы, вы можете установить `mitmproxy` прямо на Android устройство в `termux`. После установки приложения `termux`, откройте его и выполните следующие команды:

```bash
pkg update
pkg install python openssl-1.1-static
python3 -m pip install --upgrade pip

CRYPTOGRAPHY_DONT_BUILD_RUST=1 CRYPTOGRAPHY_SUPPRESS_LINK_FLAGS=1 \
  LDFLAGS="$PREFIX/lib/openssl-1.1/libssl.a $PREFIX/lib/openssl-1.1/libcrypto.a" \
  CFLAGS="-I$PREFIX/include/openssl-1.1" \
  pip install mitmproxy==7.0.4
```

Это установит `mitmproxy` версии 7.0.4, который является последней версией, не требующей `rust`. Если вы хотите установить версию 8+, следуйте [данным инструкциям](https://t.me/PCAPdroid/10071).

**Примечание**: при установки на Android устройство посредством termux, необходимо выбрать конкретное целевое приложение, чтобы не захватывать траффик других приложений. В ином случае траффик из termux зациклится, лишив тем самым устройство подключения к интернету.

После установки `mitmproxy`, необходимо выполнить следующие шаги:

1. Запустить `mitmproxy` без каких-либо опций, тогда он сгенерирует mitm сертификат. Установите сертификат (обычно расположен в `~/.mitmproxy/mitmproxy-ca-cert.cer`) на Android устройстве. Возможно, для этого потребуется заменить расширение `.cer` на расширение `.crt`
2. Откройте настройки PCAPdroid
3. Активируйте опцию "Включить SOCKS5 прокси"
4. Укажите IP адрес и порт для будущего экземпляра mitmproxy (порт 8050 в этом примере)
5. Запустите mitmproxy в режиме SOCKS5, с помощью команды `mitmproxy --mode socks5 --listen-port 8050`

С этого момента PCAPdroid будет перенаправлять весь TCP траффик на mitmproxy сервер, который будет проксировать соединения и дешифровывать TLS траффик. Однако помните, что генерируемый в PCAPdroid дамп по прежнему будет содержать зашифрованный траффик вместе с оригинальными IP адресами назначения и портами.
